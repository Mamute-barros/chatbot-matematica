<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Chatbot de Matem√°tica para Crian√ßas</title>
<style>
  body {
    font-family: 'Comic Sans MS', cursive, sans-serif;
    background: -webkit-linear-gradient(135deg, #a8edea, #fed6e3);
    background: -moz-linear-gradient(135deg, #a8edea, #fed6e3);
    background: linear-gradient(135deg, #a8edea, #fed6e3);
    margin: 0; padding: 20px;
    display: -webkit-box; display: -ms-flexbox; display: flex;
    -webkit-box-orient: vertical; -webkit-box-direction: normal;
    -ms-flex-direction: column; flex-direction: column;
    -webkit-box-align: center; -ms-flex-align: center; align-items: center;
    height: 100vh;
    -webkit-tap-highlight-color: transparent;
  }
  h2 {
    color: #4a90e2;
    text-shadow: 1px 1px 2px #fff;
    margin-bottom: 10px;
    text-align: center;
  }
  #chatbox {
    width: 100%; max-width: 480px; height: 500px;
    background: #fff; border-radius: 15px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    padding: 15px; overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    display: -webkit-box; display: -ms-flexbox; display: flex;
    -webkit-box-orient: vertical; -webkit-box-direction: normal;
    -ms-flex-direction: column; flex-direction: column;
    gap: 10px;
  }
  .message {
    max-width: 75%; padding: 12px 18px;
    border-radius: 20px; font-size: 18px; line-height: 1.4;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    white-space: pre-line; word-wrap: break-word; word-break: break-word;
  }
  .user {
    -ms-flex-item-align: end; align-self: flex-end;
    background: #4a90e2; color: white;
    border-bottom-right-radius: 0;
  }
  .bot {
    -ms-flex-item-align: start; align-self: flex-start;
    background: #f7cac9; color: #333;
    border-bottom-left-radius: 0;
  }
  #inputArea {
    margin-top: 15px; width: 100%; max-width: 480px;
    display: -webkit-box; display: -ms-flexbox; display: flex;
    gap: 10px;
  }
  #userInput {
    -webkit-box-flex: 1; -ms-flex-positive: 1; flex-grow: 1;
    font-size: 18px; padding: 12px 15px;
    border-radius: 25px; border: 2px solid #4a90e2;
    outline: none;
    -webkit-transition: border-color 0.3s;
    -moz-transition: border-color 0.3s;
    transition: border-color 0.3s;
  }
  #userInput:focus {
    border-color: #f7cac9;
  }
  #sendBtn {
    background: #4a90e2; border: none; color: white;
    font-size: 18px; padding: 12px 25px; border-radius: 25px;
    cursor: pointer; box-shadow: 0 4px 8px rgba(74,144,226,0.4);
    -webkit-transition: background-color 0.3s;
    -moz-transition: background-color 0.3s;
    transition: background-color 0.3s;
    -webkit-tap-highlight-color: transparent;
  }
  #sendBtn:hover, #sendBtn:active {
    background: #357ABD;
  }
  #clearBtn {
    margin-top: 10px; padding: 12px 20px; border-radius: 25px;
    border: none; background: #f7cac9; color: #333;
    cursor: pointer; font-size: 18px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    -webkit-transition: background-color 0.3s;
    -moz-transition: background-color 0.3s;
    transition: background-color 0.3s;
    -webkit-tap-highlight-color: transparent;
  }
  #clearBtn:hover, #clearBtn:active {
    background: #e6b8b7;
  }
  #typingIndicator {
    font-style: italic; color: #666; margin-top: 5px;
    height: 20px; min-height: 20px;
  }
  #chatbox::-webkit-scrollbar {
    width: 8px;
  }
  #chatbox::-webkit-scrollbar-track {
    background: #f1f1f1; border-radius: 10px;
  }
  #chatbox::-webkit-scrollbar-thumb {
    background: #4a90e2; border-radius: 10px;
  }
  @media (max-width: 520px) {
    #chatbox { height: 400px; }
    #userInput, #sendBtn, #clearBtn {
      font-size: 20px; padding: 15px 20px;
    }
    #inputArea { gap: 8px; }
  }
</style>
</head>
<body>

<h2>Chatbot de Matem√°tica para Crian√ßas</h2>
<div id="chatbox" role="log" aria-live="polite" aria-relevant="additions"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="Digite sua pergunta ou conta aqui..." aria-label="Entrada do usu√°rio" autocomplete="off" />
  <button id="sendBtn" aria-label="Enviar mensagem">Enviar</button>
</div>

<button id="clearBtn" aria-label="Limpar chat">Limpar chat</button>
<div id="typingIndicator" aria-live="polite"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>

<script>
  (function() {
    var chatbox = document.getElementById('chatbox');
    var userInput = document.getElementById('userInput');
    var sendBtn = document.getElementById('sendBtn');
    var clearBtn = document.getElementById('clearBtn');
    var typingIndicator = document.getElementById('typingIndicator');

    function addMessage(text, sender) {
      var message = document.createElement('div');
      message.className = 'message ' + sender;
      message.textContent = text;
      chatbox.appendChild(message);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function factorial(n) {
      if (n < 0) return NaN;
      if (n === 0 || n === 1) return 1;
      var f = 1;
      for (var i = 2; i <= n; i++) {
        f *= i;
      }
      return f;
    }

    function removerAcentos(str) {
      return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[.,!?]/g, "");
    }

    // Explica√ß√µes sucintas para fun√ß√µes matem√°ticas
    function explicacoesBasicas(operacao, a, b) {
      switch(operacao) {
        case 'soma':
          return 'Soma: juntar n√∫meros. Ex: ' + a + ' + ' + b + ' = ' + (a + b) + '.';
        case 'subtracao':
          return 'Subtra√ß√£o: tirar uma quantidade. Ex: ' + a + ' - ' + b + ' = ' + (a - b) + '.';
        case 'multiplicacao':
          return 'Multiplica√ß√£o: somar v√°rias vezes. Ex: ' + a + ' √ó ' + b + ' = ' + (a * b) + '.';
        case 'divisao':
          if (b === 0) return 'Divis√£o por zero n√£o √© poss√≠vel.';
          return 'Divis√£o: repartir em partes iguais. Ex: ' + a + ' √∑ ' + b + ' = ' + (a / b) + '.';
        case 'potencia':
          return 'Pot√™ncia: multiplicar n√∫mero por ele mesmo. Ex: ' + a + '^' + b + ' = ' + Math.pow(a,b) + '.';
        case 'raiz':
          return 'Raiz quadrada: n√∫mero que multiplicado por ele mesmo d√° o original. Ex: ‚àö' + a + ' = ' + Math.sqrt(a) + '.';
        case 'fatorial':
          var f = factorial(a);
          return 'Fatorial: produto de todos os n√∫meros at√© ' + a + '. Ex: ' + a + '! = ' + f + '.';
        case 'porcentagem':
          if (b === 0) return 'O total n√£o pode ser zero.';
          var p = (a / b) * 100;
          return 'Porcentagem: parte de 100. Ex: ' + a + ' √© ' + p.toFixed(2) + '% de ' + b + '.';
        default:
          return '';
      }
    }

    // Respostas r√°pidas para cumprimentos, apresenta√ß√µes e despedidas
    function respostasRapidas(texto) {
      var t = texto.toLowerCase();
      if (/(oi|ola|ol√°|bom dia|boa tarde|boa noite)/.test(t)) {
        return 'Ol√°! Como posso ajudar com matem√°tica hoje? üòä';
      }
      if (/(tchau|adeus|at√© logo|falou)/.test(t)) {
        return 'At√© mais! Volte sempre que quiser aprender matem√°tica! üëã';
      }
      if (/(quem √© voc√™|o que √© voc√™|apresente-se)/.test(t)) {
        return 'Eu sou um chatbot que ajuda crian√ßas a aprender matem√°tica de forma divertida! üéâ';
      }
      return null;
    }

    // Detecta se "x" √© inc√≥gnita e pede para usar "*" para multiplica√ß√£o
    function verificaIncognita(input) {
      // Regex simples para detectar padr√£o de inc√≥gnita: n√∫mero seguido de x e n√∫mero ou s√≠mbolo
      var regexIncognita = /\d+x\d+/i;
      if (regexIncognita.test(input)) {
        return true;
      }
      return false;
    }

    // Resolve equa√ß√µes simples do tipo ax + b = c
    function solveSimpleEquation(input) {
      var eqRegex = /^([\d\.]*)x\s*([\+\-])\s*([\d\.]+)\s*=\s*([\d\.]+)$/;
      var match = input.replace(/\s+/g, '').match(eqRegex);
      if (match) {
        var a = parseFloat(match[1]);
        if (isNaN(a)) a = 1;
        var sign = match[2];
        var b = parseFloat(match[3]);
        var c = parseFloat(match[4]);
        var x;
        if (sign === '+') {
          x = (c - b) / a;
        } else {
          x = (c + b) / a;
        }
        return 'A solu√ß√£o da equa√ß√£o ' + input + ' √© x = ' + x.toFixed(2) + '.';
      }
      return null;
    }

    // Fun√ß√£o principal para processar entrada e gerar resposta
    function processInput(input) {
      var textoOriginal = input;
      input = input.toLowerCase().trim();
      var textoNormalizado = removerAcentos(input);

      // Respostas r√°pidas
      var rapida = respostasRapidas(input);
      if (rapida) return rapida;

      // Detecta inc√≥gnita mal usada
      if (verificaIncognita(input)) {
        return 'Parece que voc√™ usou "x" para multiplica√ß√£o junto a n√∫meros. Por favor, use "*" para multiplicar, por exemplo: 2*3 em vez de 2x3.';
      }

      // Explica√ß√µes sucintas para opera√ß√µes
      var explRegex = /(explique|passo a passo|como funciona).*(soma|subtracao|multiplicacao|divisao|potencia|raiz|fatorial|porcentagem)/i;
      var explMatch = textoNormalizado.match(explRegex);
      if (explMatch) {
        var op = explMatch[2];
        // Tenta extrair n√∫meros para explica√ß√£o
        var nums = textoNormalizado.match(/\d+/g) || [];
        var a = nums.length > 0 ? parseInt(nums[0],10) : 0;
        var b = nums.length > 1 ? parseInt(nums[1],10) : 0;
        return respostaAmigavel(explicacoesBasicas(op, a, b));
      }

      // Explica√ß√£o para inc√≥gnita
      if (textoNormalizado.indexOf('incognita') !== -1 || textoNormalizado.indexOf('inc√≥gnita') !== -1) {
        return 'Inc√≥gnita √© o s√≠mbolo (geralmente "x") que representa um n√∫mero desconhecido em uma conta. Resolver a conta √© descobrir o valor dessa inc√≥gnita.';
      }

      // Tenta resolver equa√ß√£o simples
      var eqSol = solveSimpleEquation(textoOriginal);
      if (eqSol) return eqSol;

      // Tenta calcular express√£o matem√°tica com math.js
      try {
        var expression = textoOriginal
          .replace(/x/g, '*') // substitui x por multiplica√ß√£o
          .replace(/√∑/g, '/')
          .replace(/‚àö/g, 'sqrt')
          .replace(/(\d+)!/g, 'factorial($1)')
          .replace(/%/g, '*0.01');

        var scope = { factorial: factorial };
        var result = math.evaluate(expression, scope);

        if (typeof result === 'number' && !isNaN(result)) {
          return 'O resultado de ' + textoOriginal + ' √© ' + result + '.';
        } else {
          return 'N√£o consegui calcular essa express√£o. Tente outra, por favor.';
        }
      } catch(e) {
        return 'N√£o entendi a express√£o. Pode tentar de novo?';
      }
    }

    function processAndRespond() {
      var input = userInput.value.trim();
      if (!input) return;
      addMessage(input, 'user');
      userInput.value = '';
      userInput.focus();

      typingIndicator.textContent = 'Digitando...';

      setTimeout(function() {
        var response = processInput(input);
        addMessage(response, 'bot');
        typingIndicator.textContent = '';
      }, 700);
    }

    sendBtn.addEventListener('click', processAndRespond);
    userInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        processAndRespond();
      }
    });

    clearBtn.addEventListener('click', function() {
      chatbox.innerHTML = '';
      typingIndicator.textContent = '';
      addMessage('Chat limpo! Pode come√ßar uma nova conversa.', 'bot');
      userInput.focus();
    });

    window.onload = function() {
      addMessage('Ol√°! Sou seu assistente de matem√°tica. Pergunte algo ou digite "ajuda". üòä', 'bot');
      userInput.focus();
    };
  })();
</script>

</body>
</html>
